name: Auto Release

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_and_publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (fetch all tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next Vx version and changed files
        id: version
        run: |
          set -euo pipefail

          # Determine latest V* tag
          LAST_TAG=$(git tag -l "V[0-9]*" | sort -V | tail -n1 || true)

          if [ -z "${LAST_TAG}" ]; then
            NEXT=1
            CHANGED=$(git ls-files -z | tr '\0' '\n')
          else
            NUM=${LAST_TAG#V}
            if ! printf '%s\n' "$NUM" | grep -Eq '^[0-9]+$'; then
              NEXT=1
            else
              NEXT=$((NUM + 1))
            fi
            CHANGED=$(git diff --name-only -z "$LAST_TAG" HEAD | tr '\0' '\n')
          fi

          RELEASE_TAG="V${NEXT}"
          ZIP_FILE="the-fun-guns-${RELEASE_TAG}.zip"

          echo "Determined next tag: ${RELEASE_TAG}"
          echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_ENV
          echo "ZIP_FILE=${ZIP_FILE}" >> $GITHUB_ENV

          # Build release body based on trigger type
          RELEASE_BODY_FILE=release_body.txt
          
          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            # Manual trigger - create changelog with commit messages and contributors
            {
              echo "Changelog since ${LAST_TAG:-the beginning}:"
              echo ""
              if [ -z "${CHANGED}" ]; then
                echo "(no file changes detected)"
              else
                # Get unique file changes with their latest commit messages
                echo "### File Changes:"
                while IFS= read -r -d '' file; do
                  if [ -n "$file" ]; then
                    COMMIT_MSG=$(git log --oneline --follow -1 -- "$file" | sed 's/^[^ ]* //')
                    echo "- **$file**: $COMMIT_MSG"
                  fi
                done < <(printf '%s' "$CHANGED" | tr '\n' '\0')
                echo ""
                
                # Get unique contributors since last tag
                echo "### Contributors:"
                if [ -z "${LAST_TAG}" ]; then
                  CONTRIBUTORS=$(git log --pretty=format:"%an" HEAD | sort -u)
                else
                  CONTRIBUTORS=$(git log --pretty=format:"%an" "${LAST_TAG}"..HEAD | sort -u)
                fi
                if [ -z "$CONTRIBUTORS" ]; then
                  echo "- (no contributors)"
                else
                  echo "$CONTRIBUTORS" | while read -r contributor; do
                    echo "- $contributor"
                  done
                fi
              fi
            } > "${RELEASE_BODY_FILE}"
          else
            # Push trigger - original format
            {
              echo "Changed files included in ${RELEASE_TAG}:"
              echo ""
              if [ -z "${CHANGED}" ]; then
                echo "(no file changes detected)"
              else
                printf '%s\n' "${CHANGED}" | sed 's/^/- /'
              fi
              echo ""
              echo "Generated by GitHub Actions."
            } > "${RELEASE_BODY_FILE}"
          fi
          
          echo "RELEASE_BODY_FILE=${RELEASE_BODY_FILE}" >> $GITHUB_ENV

      - name: Create ZIP artifact (exclude docs, DBs, git metadata, VS files, workflows)
        run: |
          rm -f "${ZIP_FILE}"
          zip -r "${ZIP_FILE}" . \
            -x "*.md" \
            -x "LICENSE" \
            -x "*.db" \
            -x ".vs/*" \
            -x ".gitignore" \
            -x ".git/*" \
            -x ".github/*" \
            -x "*.yaml"

      - name: Create git tag and push
        env:
          RELEASE_TAG: ${{ env.RELEASE_TAG }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "${RELEASE_TAG}"
          git push origin "${RELEASE_TAG}"

      - name: Determine release type
        id: release_type
        run: |
          # Manual dispatch = full release; push = prerelease
          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
          else
            echo "IS_PRERELEASE=true" >> $GITHUB_ENV
          fi

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          release_name: The Fun Guns ${{ env.RELEASE_TAG }}
          body_path: ${{ env.RELEASE_BODY_FILE }}
          draft: false
          prerelease: ${{ env.IS_PRERELEASE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release asset (ZIP)
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.ZIP_FILE }}
          asset_name: ${{ env.ZIP_FILE }}
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
